{{ define "main" }}
  {{ range .Resources.ByType "page"}}
    {{ if and (not .Params.disabled) (eq .Params.fragment "hero") }}
      {{ partial "fragments/hero.html" (dict "tmp_full" $ "resources" $.Resources "self" . ) }}
    {{ end }}
  {{ end }}

  {{ if .Content }}
    {{ partial "content-single.html" . }}
  {{ end }}

  {{/*
    This code may not be understandable immediately. This is trying to find all
    the resources (read fragments) for each page and all the global fragments.
    When combining global and local fragments, local ones have more priority.
    So if there is only one footer fragment and that is global, that footer
    fragment is shown. The same is true if there are no global footer fragments
    and one local one. But if there is one global footer fragment and one local
    footer fragment, the local one is rendered.
    */}}
  {{ $global := .Site.GetPage "page" "global" }}
  {{ $global_fragments := $global.Resources.ByType "page" }}
  {{ $local_fragments := .Resources.ByType "page" }}

  {{ $.Scratch.Delete "fragments" }}
  {{ range $local_fragments }}
    {{ $.Scratch.Add "fragments" (slice .) }}
  {{ end }}
  {{ range $global_fragments }}
    {{ if not (where ($.Scratch.Get "fragments") ".Name" .Name) }}
      {{ $.Scratch.Add "fragments" (slice .) }}
    {{ end }}
  {{ end }}

  {{ range sort ($.Scratch.Get "fragments") "Params.weight" }}
    {{ if and (not .Params.disabled) (isset .Params "fragment") (not (eq .Params.fragment "hero")) }}
      {{ partial (print "fragments/" .Params.fragment ".html") (dict "menus" $.Site.Menus "Site" $.Site "resources" $.Resources "self" .) }}
    {{ end }}
  {{ end }}
{{ end }}
