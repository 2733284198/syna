{{- $self := . -}}
{{/* Sets page to either the given frontmatter section variable, current
  parent section or if the current page is a section, the current page */}}
{{- .page_scratch.Set "page" (.Site.GetPage "Section" (.Params.section | default .root.Section)) -}}
{{- if and (not .Params.section) (eq .root.CurrentSection.Kind "section") -}}
  {{- .page_scratch.Set "page" .root.CurrentSection -}}
{{- end -}}

{{- .page_scratch.Set "pages" (.page_scratch.Get "page").Pages -}}
{{- if .Params.subsections -}}
  {{- .page_scratch.Add "pages" (.page_scratch.Get "page").Sections -}}
{{- end -}}
{{- if .Params.subsection_leaves -}}
  {{- range (.page_scratch.Get "page").Sections -}}
    {{- $self.page_scratch.Add "pages" .Pages -}}
  {{- end -}}
{{- end -}}

{{/* Pagination is used if paginate (default value is 10) is more than
  frontmatter count variable */}}
{{- $renderPagination := and (in (slice "section" "home") .root.Kind) (or (not (isset .Params "count")) (le .Params.count 0)) -}}
{{- if $renderPagination -}}
  {{- $paginator := .root.Paginate ($self.page_scratch.Get "pages") -}}
  {{- .page_scratch.Set "pages" $paginator.Pages -}}
  {{- .page_scratch.Set "paginator" $paginator -}}
{{- end }}

{{ "<!-- Blog -->" | safeHTML }}
<section id="{{ .Name }}">
  <div class="overlay container-fluid
    {{- partial "helpers/background.html" $self.self -}}
  ">
    {{- $bg := $self.self.Scratch.Get "bg" }}
    <div class="container py-5">
      {{- partial "helpers/section-header.html" (dict "bg" $bg "params" .Params) }}
      <div class="row mx-0">
        <div class="row mx-0
          {{- partial "helpers/text-color.html" (dict "self" $self.self "muted" true "light" "secondary") -}}
        ">
          {{- range first (.Params.count | default 10) (.page_scratch.Get "pages") -}}
            {{ $self.page_scratch.Set "pages" (slice .) }}
            {{ range .Resources.ByType "page" }}
              {{ $self.page_scratch.Add "pages" . }}
            {{ end }}
            {{- if $self.Params.tiled -}}
              <div class="col-lg-6 col-12 mb-2 d-flex">
            {{- end -}}
              <article class="
                {{- if $self.Params.tiled -}}
                  {{- printf "card w-100" -}}
                {{- else -}}
                  {{- printf "col-12 mb-4" -}}
                {{- end -}}">
                {{- if $self.Params.tiled }}
                  <div class="card-body">
                {{- end -}}
                  {{- if .Params.title -}}
                    {{- if $self.Params.tiled }}
                      <div class="card-title">
                    {{- end }}
                      <div class="col-12 pl-0
                {{- partial "helpers/text-color.html" (dict "self" $self.self) -}}
                      ">
                        <a href="{{ .URL }}">
                          <h3>
                            {{- .Params.title | markdownify -}}
                          </h3>
                        </a>
                      </div>
                      <div class="col-12 pb-2 px-0">
                        {{- if $self.Params.display_date -}}
                          {{- range first 1 (where ($self.page_scratch.Get "pages") "Params.fragment" "in" "content") -}}
                            {{- partial "helpers/publish-date.html" (dict "root" . "background" $bg) -}}
                          {{- end -}}
                        {{- end -}}
                        {{- with .Params.categories }}
                          {{- partial "helpers/categories.html" (dict "categories" . "background" $bg) -}}
                        {{- end -}}
                      </div>
                    {{- if $self.Params.tiled }}
                      </div>
                    {{- end -}}
                  {{- end -}}
                  {{- if .Params.asset -}}
                    <a href="{{ .URL }}">
                      <img src="{{ partial "helpers/image.html" (dict "root" $self "asset" .Params.asset) }}" alt="{{ .Params.subtitle | default .Params.title }}" class="img-fluid mb-4">
                    </a>
                  {{- end -}}
                  {{- if or (not (isset $self.Params "summary")) (eq $self.Params.summary true) }}
                    <div class="col-12 pl-0
                      {{- partial "helpers/text-color.html" (dict "self" $self.self "muted" true "light" "secondary") -}}
                    ">
                      {{- range first 1 (where ($self.page_scratch.Get "pages") "Params.fragment" "in" "content") }}
                        {{ .Summary }}
                        {{- if and (not $self.Params.tiled) (ne $self.Params.read_more false) -}}
                          {{- if or $self.Params.read_more .Truncated }}
                            <a class="badge 
                              {{- if or (eq $bg "secondary") (eq $bg "primary") -}}
                                {{- printf " badge-%s" "dark" -}}
                              {{- else -}}
                                {{- printf " badge-%s" "secondary" -}}
                              {{- end -}}
                            " href="{{ .URL }}">{{ i18n "content.readmore" | default "Read more..." }}</a>
                          {{- end -}}
                        {{- end -}}
                      {{- end -}}
                    </div>
                  {{- end -}}
                {{- if $self.Params.tiled }}
                  </div>
                  {{- range first 1 (where ($self.page_scratch.Get "pages") "Params.fragment" "in" "content") }}
                    {{- if and (ne $self.Params.read_more false) (or $self.Params.read_more .Truncated) }}
                      <div class="card-footer">
                        <a href="{{ .URL }}">{{ i18n "content.readmore" | default "Read more..." }}</a>
                      </div>
                    {{- end -}}
                  {{- end -}}
                {{- end }}
              </article>
            {{- if $self.Params.tiled }}
              </div>
            {{- end -}}
          {{- end }}
        </div>
        {{- if $renderPagination -}}
          {{- partial "helpers/pagination.html" (dict "paginator" .root.Paginator) -}}
        {{- end }}
      </div>
    </div>
  </div>
</section>
