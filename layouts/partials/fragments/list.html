{{- $self := . -}}
{{/*
  This variable stores all the page bundles in the blog section. There are three
  where functions achieving this. First where gets all the pages in blog
  section, the second one removes current page from the mix and the last one
  removes the section (.Site.Pages returns the current section as a page). */}}
{{- .page_scratch.Set "pages" (.Site.GetPage "Section" (.Params.section | default .root.Section)).Pages -}}
{{- .page_scratch.Add "pages" (.Site.GetPage "Section" (.Params.section | default .root.Section)).Sections -}}
{{- if and .is_list (not .Params.count) -}}
  {{- $paginator := .root.Paginate (.page_scratch.Get "pages") -}}
  {{- .page_scratch.Set "pages" $paginator.Pages -}}
  {{- .page_scratch.Set "paginator" $paginator}}
{{- else -}}
  {{- if and (not .Params.section) (eq .root.CurrentSection.Kind "section") -}}
    {{- .page_scratch.Set "pages" (.root.CurrentSection.Pages) -}}
    {{- if (ne .Params.subsections false) -}}
      {{- .page_scratch.Add "pages" .root.CurrentSection.Sections -}}
    {{- end -}}
    {{- if .Params.subsection_leaves -}}
      {{- range .root.CurrentSection.Sections -}}
        {{- $self.page_scratch.Add "pages" .Pages -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}
{{- $bg := .Params.background | default "light" }}

{{ "<!-- Blog -->" | safeHTML }}
<section id="{{ .Name }}">
  <div class="overlay container-fluid {{- printf " bg-%s" $bg -}}">
    <div class="container py-5">
      <div class="row mx-0">
        <div class="row mx-0
          {{- if or (eq $bg "secondary") (eq $bg "primary") -}}
            {{- printf " text-%s" "dark" -}}
          {{- else -}}
            {{- printf " text-muted text-%s" "secondary" -}}
          {{- end -}}
        ">
          {{- range first (.Params.count | default 10) (.page_scratch.Get "pages") }}
            {{- if $self.Params.tiled -}}
              <div class="col-lg-6 col-12 mb-2 d-flex">
            {{- end -}}
              <article class="
                {{- if $self.Params.tiled -}}
                  {{- printf "card w-100" -}}
                {{- else -}}
                  {{- printf "col-12 mb-4" -}}
                {{- end -}}">
                {{- if $self.Params.tiled }}
                  <div class="card-body">
                {{- end -}}
                  {{- if .Params.title -}}
                    {{- if $self.Params.tiled }}
                      <div class="card-title">
                    {{- end }}
                      <div class="col-12 pl-0
                        {{- if or (eq $bg "white") (eq $bg "light") (eq $bg "secondary") (eq $bg "primary") -}}
                          {{- printf " text-%s" "dark" -}}
                        {{- else -}}
                          {{- printf " text-%s" "light" -}}
                        {{- end -}}
                      ">
                        <a href="{{ .URL }}">
                          <h3>
                            {{- .Params.title | markdownify -}}
                          </h3>
                        </a>
                      </div>
                    {{- if $self.Params.tiled }}
                      </div>
                    {{- end -}}
                  {{- end -}}
                  {{- if .Params.asset -}}
                    <a href="{{ .URL }}">
                      <img src="{{ partial "helpers/image.html" (dict "root" $self "asset" .Params.asset) }}" alt="{{ .Params.subtitle | default .Params.title }}" class="img-fluid mb-4">
                    </a>
                  {{- end -}}
                  {{ $self.page_scratch.Set "pages" (slice .) }}
                  {{ range .Resources.ByType "page" }}
                    {{ $self.page_scratch.Add "pages" . }}
                  {{ end }}
                  {{- if or (not (isset $self.Params "summary")) (eq $self.Params.summary true) }}
                    <div class="col-12 pl-0
                      {{- if or (eq $bg "secondary") (eq $bg "primary") -}}
                        {{- printf " text-%s" "dark" -}}
                      {{- else -}}
                        {{- printf " text-muted text-%s" "secondary" -}}
                      {{- end -}}
                    ">
                      {{- range first 1 (where ($self.page_scratch.Get "pages") "Params.fragment" "in" "content") }}
                        {{ .Summary }}
                        {{- if and (not $self.Params.tiled) (ne $self.Params.read_more false) -}}
                          {{- if or $self.Params.read_more .Truncated }}
                            <a class="badge
                            {{- if or (eq $bg "secondary") (eq $bg "primary") -}}
                              {{- printf " badge-%s" "dark" -}}
                            {{- else -}}
                              {{- printf " badge-%s" "secondary" -}}
                            {{- end -}}" href="{{ .URL }}">{{ i18n "content.readmore" | default "Read more..." }}</a>
                          {{- end -}}
                        {{- end -}}
                      {{- end -}}
                    </div>
                  {{- end -}}
                {{- if $self.Params.tiled }}
                  </div>
                  {{- range first 1 (where ($self.page_scratch.Get "pages") "Params.fragment" "in" "content") }}
                    {{- if and (ne $self.Params.read_more false) (or $self.Params.read_more .Truncated) }}
                      <div class="card-footer">
                        <a href="{{ .URL }}">{{ i18n "content.readmore" | default "Read more..." }}</a>
                      </div>
                    {{- end -}}
                  {{- end -}}
                {{- end }}
              </article>
            {{- if $self.Params.tiled }}
              </div>
            {{- end -}}
          {{- end }}
        </div>
        {{- if .is_list }}
          {{ $paginator := .root.Paginator }}
          {{ if gt $paginator.TotalPages 1 }}
            <ul class="pagination justify-content-center w-100 mt-4">
              {{ if ne $paginator.PageNumber 1 }}
                <li class="page-item">
                  <a class="page-link" href="{{ $paginator.First.URL }}">
                    {{ i18n "list.first" | default "First" }}
                  </a>
                </li>
              {{ end }}
              {{ if $paginator.HasPrev }}
                <li class="page-item">
                  <a href="{{ $paginator.Prev.URL }}" class="page-link">
                    {{ i18n "list.previous" | default "Previous" }}
                  </a>
                </li>
              {{ else }}
                <li class="page-item disabled">
                  <a class="page-link" href="#" tabindex="-1">Previous</a>
                </li>
              {{ end }}
              {{ range $paginator.Pagers }}
                {{ $adjacent_links := 2 }}
                {{ $max_links := (add (mul $adjacent_links 2) 1) }}
                {{ $lower_limit := (add $adjacent_links 1) }}
                {{ $.page_scratch.Set "page_number_flag" false }}
                {{ if gt $paginator.TotalPages $adjacent_links }}
                  {{ $upper_limit := sub $paginator.TotalPages $adjacent_links }}
                  {{ $.page_scratch.Set "page_number_flag" false }}
                  {{ if gt $paginator.TotalPages $max_links }}
                    {{ if le $paginator.PageNumber $lower_limit }}
                      {{ if le .PageNumber $max_links }}
                        {{ $.page_scratch.Set "page_number_flag" true }}
                      {{ end }}
                    {{ else if ge $paginator.PageNumber $upper_limit }}
                      {{ if gt .PageNumber (sub $paginator.TotalPages $max_links) }}
                        {{ $.page_scratch.Set "page_number_flag" true }}
                      {{ end }}
                    {{ else }}
                      {{ if and ( ge .PageNumber (sub $paginator.PageNumber $adjacent_links) ) ( le .PageNumber (add $paginator.PageNumber $adjacent_links) ) }}
                        {{ $.page_scratch.Set "page_number_flag" true }}
                      {{ end }}
                    {{ end }}
                  {{ else }}
                    {{ $.page_scratch.Set "page_number_flag" true }}
                  {{ end }}
                  {{ if eq ($.page_scratch.Get "page_number_flag") true }}
                    <li class="page-item {{ if eq . $paginator }} active{{ end }}">
                      <a href="{{ .URL }}" class="page-link">
                        {{ .PageNumber }}
                        {{ if eq . $paginator }}
                          <span class="sr-only">(current)</span>
                        {{ end }}
                      </a>
                    </li>
                  {{ end }}
                {{ else }}
                  <li class="page-item {{ if eq . $paginator }}{{ printf " active" }}{{ end }}">
                    <a href="{{ .URL }}" class="page-link">
                      {{ .PageNumber }}
                    </a>
                  </li>
                {{ end }}
              {{ end }}
              {{ if $paginator.HasNext }}
                <li class="page-item">
                  <a href="{{ $paginator.Next.URL }}" class="page-link">
                    {{ i18n "list.next" | default "Next" }}
                  </a>
                </li>
              {{ else }}
                <li class="page-item disabled">
                  <a class="page-link" href="#" tabindex="-1">Next</a>
                </li>
              {{ end }}
              {{ if ne $paginator.PageNumber $paginator.TotalPages }}
                <li class="page-item">
                  <a class="page-link" href="{{ $paginator.Last.URL }}">
                    {{ i18n "list.last" | default "Last" }}
                  </a>
                </li>
              {{ end }}
            </ul>
          {{ end }}
        {{- end }}
      </div>
    </div>
  </div>
</section>
