{{- $self := . -}}
{{/* Sets page to either the given frontmatter section variable, current
  parent section or if the current page is a section, the current page */}}
{{- .page_scratch.Set "page" (.Site.GetPage "Section" (.Params.section | default .root.Section)) -}}
{{- if and (not .Params.section) (eq .root.CurrentSection.Kind "section") -}}
  {{- .page_scratch.Set "page" .root.CurrentSection -}}
{{- end -}}

{{- .page_scratch.Set "pages" (.page_scratch.Get "page").Pages -}}
{{- if .Params.subsections -}}
  {{- .page_scratch.Add "pages" (.page_scratch.Get "page").Sections -}}
{{- end -}}
{{- if .Params.subsection_leaves -}}
  {{- range (.page_scratch.Get "page").Sections -}}
    {{- $self.page_scratch.Add "pages" .Pages -}}
  {{- end -}}
{{- end -}}

{{/* Pagination is used if paginate (default value is 10) is more than
  frontmatter count variable */}}
{{- $renderPagination := and (in (slice "section" "home") .root.Kind) (or (not (isset .Params "count")) (le .Params.count 0)) -}}
{{- if $renderPagination -}}
  {{- $paginator := .root.Paginate ($self.page_scratch.Get "pages") -}}
  {{- .page_scratch.Set "pages" $paginator.Pages -}}
  {{- .page_scratch.Set "paginator" $paginator -}}
{{- end -}}

{{- $bg := .Params.background | default "light" }}

{{ "<!-- Blog -->" | safeHTML }}
<section id="{{ .Name }}">
  <div class="overlay container-fluid {{- printf " bg-%s" $bg -}}">
    <div class="container py-5">
      {{- partial "helpers/section-header.html" (dict "bg" $bg "params" .Params) }}
      <div class="row mx-0
        {{- if or (eq $bg "secondary") (eq $bg "primary") -}}
          {{- printf " text-%s" "dark" -}}
        {{- else -}}
          {{- printf " text-muted text-%s" "secondary" -}}
        {{- end -}}
      ">
        {{- range first (.Params.count | default 10) (.page_scratch.Get "pages") -}}
          {{- $self.page_scratch.Set "pages" (slice .) -}}
          {{- range .Resources.ByType "page" -}}
            {{- $self.page_scratch.Add "pages" . -}}
          {{- end -}}
          {{- $display_summary := or (not (isset $self.Params "summary")) (eq $self.Params.summary true) -}}
          {{- if $self.Params.tiled -}}
            <div class="col-lg-6 col-12 mb-2 d-flex">
          {{- end -}}
            <article class="
              {{- if $self.Params.tiled -}}
                {{- print "card w-100" -}}
              {{- else -}}
                {{- printf "col-12 mb-%s" (cond $display_summary "4" "2") -}}
              {{- end -}}">
              {{- if $self.Params.tiled }}
                <div class="card-body">
              {{- end -}}
                {{- if .Params.title -}}
                  {{- if $self.Params.tiled }}
                    <div class="card-title">
                  {{- end }}
                    <div class="col-12 pl-0
                      {{- if or (eq $bg "white") (eq $bg "light") (eq $bg "secondary") (eq $bg "primary") -}}
                        {{- printf " text-%s" "dark" -}}
                      {{- else -}}
                        {{- printf " text-%s" "light" -}}
                      {{- end -}}
                    ">
                      <div class="row align-items-center justify-content-between mx-0">
                        {{- if $display_summary }}
                          <h4 class="col-12 col-md px-0">
                            <a href="{{ .URL }}">
                              {{- .Params.title | markdownify -}}
                            </a>
                          </h4>
                        {{- else }}
                          <h5 class="col-12 col-md px-0">
                            <a href="{{ .URL }}">
                              {{- .Params.title | markdownify -}}
                            </a>
                          </h5>
                        {{- end -}}
                        {{- if and ((not $self.Params.tiled) $self.Params.display_date) }}
                          {{- range first 1 (where ($self.page_scratch.Get "pages") "Params.fragment" "in" "content") -}}
                            {{- partial "helpers/publish-date.html" (dict "root" . "background" $bg "badge" false) -}}
                          {{- end -}}
                        {{- end }}
                      </div>
                    </div>
                    {{- if or (and $self.Params.tiled $self.Params.display_date) .Params.categories -}}
                      <div class="col-12 pb-1 px-0">
                        {{- if and $self.Params.tiled $self.Params.display_date -}}
                          {{- range first 1 (where ($self.page_scratch.Get "pages") "Params.fragment" "in" "content") -}}
                            {{- partial "helpers/publish-date.html" (dict "root" . "background" $bg) -}}
                          {{- end -}}
                        {{- end -}}
                        {{- with .Params.categories }}
                          {{- partial "helpers/categories.html" (dict "categories" . "background" $bg) -}}
                        {{- end }}
                      </div>
                    {{- end }}
                  {{- if $self.Params.tiled }}
                    </div>
                  {{- end -}}
                {{- end -}}
                {{- if .Params.asset -}}
                  <a href="{{ .URL }}">
                    <img src="{{ partial "helpers/image.html" (dict "root" $self "asset" .Params.asset) }}" alt="{{ .Params.subtitle | default .Params.title }}" class="img-fluid mb-4">
                  </a>
                {{- end -}}
                {{- if $display_summary }}
                  <div class="col-12 pl-0
                    {{- if or (eq $bg "secondary") (eq $bg "primary") -}}
                      {{- printf " text-%s" "dark" -}}
                    {{- else -}}
                      {{- printf " text-muted text-%s" "secondary" -}}
                    {{- end -}}
                  ">
                    {{- range first 1 (where ($self.page_scratch.Get "pages") "Params.fragment" "in" "content") }}
                      {{ .Summary }}
                      {{- if and (not $self.Params.tiled) (ne $self.Params.read_more false) -}}
                        {{- if or $self.Params.read_more .Truncated }}
                          <a class="badge
                          {{- if or (eq $bg "secondary") (eq $bg "primary") -}}
                            {{- printf " badge-%s" "dark" -}}
                          {{- else -}}
                            {{- printf " badge-%s" "secondary" -}}
                          {{- end -}}" href="{{ .URL }}">{{ i18n "content.readmore" | default "Read more..." }}</a>
                        {{- end -}}
                      {{- end -}}
                    {{- end -}}
                  </div>
                {{- end -}}
              {{- if $self.Params.tiled }}
                </div>
                {{- range first 1 (where ($self.page_scratch.Get "pages") "Params.fragment" "in" "content") }}
                  {{- if and (ne $self.Params.read_more false) (or $self.Params.read_more .Truncated) }}
                    <div class="card-footer">
                      <a href="{{ .URL }}">{{ i18n "content.readmore" | default "Read more..." }}</a>
                    </div>
                  {{- end -}}
                {{- end -}}
              {{- end }}
            </article>
          {{- if $self.Params.tiled }}
            </div>
          {{- end -}}
        {{- end }}
      </div>
      {{- if $renderPagination -}}
        {{- partial "helpers/pagination.html" (dict "paginator" .root.Paginator "page_scratch" .page_scratch) -}}
      {{- end }}
    </div>
  </div>
</section>
