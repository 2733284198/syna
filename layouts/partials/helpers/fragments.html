{{- $page := .page -}}
{{- $real_page := .real_page -}}
{{- $page_scratch := .page_scratch -}}
{{- $root := .root -}}

{{/*
  This code may not be understandable immediately. This is trying to find all
  the resources (read fragments) for each page and all the global fragments.
  When combining global and local fragments, local ones have more priority.
  So if there is only one footer fragment and that is global, that footer
  fragment is shown. The same is true if there are no global footer fragments
  and one local one. But if there is one global footer fragment and one local
  footer fragment, the local one is rendered. Filename is checked in order to
  check for presence of local fragments since multiple files can use a single
  fragment.
  */}}

{{/* We try to find every global directory from the parent directories and the 
  local fragments */}}
{{- $page_scratch.Set "sections" (slice "/") -}}
{{- $sections := findRE "[^\\/]+" $real_page.CurrentSection.Dir -}}
{{- range ($sections | default (slice)) -}}
  {{- $page_scratch.Add "sections" . -}}
{{- end -}}
{{- $page_scratch.Add "sections" $real_page -}}
{{- $page_scratch.Set "fragment_directories" (slice) -}}
{{- range $index, $section := $page_scratch.Get "sections" -}}
  {{- $directory := $section -}}
  {{- if (eq (add $index 1) (len ($page_scratch.Get "sections"))) -}}
    {{- if ne $real_page.Kind "page" -}}
      {{/* Last item is the page being rendered. If it's a section or homepage,
        fragments must be at _index directory */}}
      {{- $page_scratch.Set "active_page" ($real_page.Site.GetPage "page" (printf "%s%s" $real_page.Dir "_index")) -}}
    {{- else -}}
      {{- $page_scratch.Set "active_page" $page -}}
    {{- end -}}
  {{- else if gt $index 1 -}}
    {{/* Sections between the first and last are found and their _global directories
      are taken into account */}}
    {{- $directory := (delimit (first (add $index 1) $sections) "/") -}}
    {{- $page_scratch.Set "active_page" ($real_page.Site.GetPage "page" (printf "%s/%s" $directory "_global")) -}}
  {{- else -}}
    {{/* First section is always the root directory and we look for it's _global
      directory */}}
    {{- $page_scratch.Set "active_page" ($real_page.Site.GetPage "page" (printf "%s/%s" $directory "_global")) -}}
  {{- end -}}
  {{- $page_scratch.Add "fragment_directories" ($page_scratch.Get "active_page") -}}
{{- end -}}

{{- $page_scratch.Set "fragments" (slice) -}}
{{- range $directory := sort ($page_scratch.Get "fragment_directories") -}}
  {{- if $directory -}}
    {{- $page_scratch.Add "fragments" . -}}
    {{- range ($directory.Resources.ByType "page") -}}
      {{- $page_scratch.Add "fragments" . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $page_scratch.Set "page_fragments" (slice) -}}
{{- if $page_scratch.Get "fragments" -}}
  {{- range ($page_scratch.Get "fragments") -}}
    {{- $name := replace .Name "/index" "" -}}
    {{- $directory_same_name := in ($page_scratch.Get "local_fragments_dirs") (printf "%s%s/" $root.Dir (replace $name ".md" "")) -}}
    {{- if and (not (where ($page_scratch.Get "page_fragments") ".Name" $name)) (not $directory_same_name) (ne .Params.fragment "404") -}}
      {{- $page_scratch.Add "page_fragments" . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $page_scratch.Set "js" (slice) -}}
{{- $.Scratch.Set "react" false -}}
{{- range sort ($page_scratch.Get "page_fragments") "Params.weight" -}}
  {{- if and (not .Params.disabled) (isset .Params "fragment") -}}
    {{/* Cleanup .Name to be more useful within fragments */}}
    {{- $name := strings.TrimSuffix ".md" (replace .Name "/index.md" "") -}}

    {{- $file_path := strings.TrimSuffix ".md" (replace .File.Path "/index.md" "") -}}
    {{- partial (print "fragments/" .Params.fragment ".html") (dict "page_scratch" $page_scratch "root" $real_page "Site" $real_page.Site "page" $page "resources" $real_page.Resources "self" . "Params" .Params "Name" $name "file_path" $file_path) -}}
  {{- end -}}
{{- end -}}
